---
title: "Classifying Retirement Plan Financial Adequacy Using Form 5500 Data"
author: "Donnie Minnick, Statistical Learning - Fall A 2025"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  word_document: default
  html_document:
    df_print: paged
subtitle: Exploratory Data Analysis and Feature Engineering
---

This analysis leverages the following R packages: `dplyr`, `lubridate`, '`stringr` and `tidyr` for data manipulation, `knitr` for report formatting, and `ggplot2` and `ggridges` for visualization.

```{r echo = FALSE, message = FALSE}
library("dplyr")
library("ggplot2")
library("ggridges")
library("knitr")
library("lubridate")
library("stringr")
library("tidyr")
```

Load Form 5500 data.

```{r}
plans <- readRDS("../data/plans.rds")
```

# Missing Data

Generate a report to check for missing values in the data at both the column and row level.

```{r}
# Create column level summary.

col_missing <- plans %>%
  summarise(across(everything(), ~ sum(is.na(.)))) %>%
  pivot_longer(cols = everything(),
               names_to = "Variable",
               values_to = "Missing_Count") %>%
  mutate(Missing_Percent = Missing_Count / nrow(plans) * 100)

# Create row level summary.

row_missing <- tibble(Variable = "Rows Any Missing",
                      Missing_Count = sum(!complete.cases(plans)),
                      Missing_Percent = sum(!complete.cases(plans)) / nrow(plans) * 100)

# Combine summaries.

missing_report <- bind_rows(col_missing, row_missing)

kable(missing_report,
      col.names = c("Variable", "Missing Count", "Missing Percent"),
      caption = "Missing Data",
      format.args = list(big.mark = ","),
      align = c("l", "r", "r"))
```

# Acknowledgement Id (ACK_ID)

Acknowledgement Id is a unique identifier assigned by the Department of Labor (DOL) or IRS when a Form 5500 filing is successfully received and acknowledged.  Think of it as a receipt number; it confirms that the filing was accepted into the system.  It’s often used for tracking, auditing, or linking filings across systems.

# Plan Year Begin/End Dates (PLAN_YEAR_BEGIN_DATE, PLAN_YEAR_END_DATE)

These dates define the reporting window for all financial and participant metrics.  Our dataset contains filings with a plan year begin date of January 1, 2023 and end date of December 31, 2023.

# Plan Effective Date (PLAN_EFFECTIVE_DATE)

Plan effective date marks the official inception of a retirement plan, i.e. the date it became active and enforceable under its governing provisions. This date anchors a plan’s life cycle, serving as a reference point for regulatory applicability, sponsor tenure, and cohort benchmarking.

From an analytic perspective, plan effective date enables several valuable transformations.  Calculating plan age from this field allows for stratification by maturity, which is useful when assessing financial readiness across vintage cohorts.  Plans initiated in different eras may reflect distinct design philosophies, contribution behaviors, or participant engagement patterns. 

In benchmarking workflows, plan effective date can be paired with business code (BUSINESS_CODE) to explore sector-specific adoption trends.

Generate a summary count of plans by plan effective year.

```{r}
summary_by_plan_effective_year <- plans %>%
  mutate(PLAN_EFFECTIVE_YEAR = as.character(year(PLAN_EFFECTIVE_DATE))) %>%
  group_by(PLAN_EFFECTIVE_YEAR) %>%
  arrange(PLAN_EFFECTIVE_YEAR) %>%
  summarise(entries = n()) %>%
  mutate(percent = round(entries / sum(entries), 2))

kable(summary_by_plan_effective_year,
      col.names = c("Year", "Plans", "Percent"),
      caption = "Summary By Plan Effective Year",
      format.args = list(big.mark = ","),
      align = c("l", "r", "r"))
```

Plot plans by plan effective year.

```{r}
ggplot(summary_by_plan_effective_year, aes(x = as.integer(PLAN_EFFECTIVE_YEAR), y = entries)) +
  geom_col(fill = "steelblue", color = "white") +
  # geom_text(aes(label = paste0(scales::comma(entries), "\n", round(percent * 100, 0), "%")),
  #           vjust = -0.3, size = 3.0) +
  labs(title = "Distribution of Plans by Plan Effective Year",
       x = "Year",
       y = "Plans") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        plot.title = element_text(size = 14, face = "bold")) +
  expand_limits(y = max(summary_by_plan_effective_year$entries) * 1.2)
```

This distribution tells a compelling story about the evolution of retirement plan adoption in the U.S.  The gradual rise from the 1940s through the 1970s reflects the early institutionalization of employer-sponsored plans, driven by post-war economic expansion and the formalization of pension structures.

The sharp uptick in the late 1970s through the 1990s coincides with major policy shifts, most notably the passage of ERISA in 1974 and the rise of defined contribution plans like 401k's in the early 1980s. This era marks a surge in plan formation, especially among small and mid-sized employers responding to new regulatory clarity and tax incentives.

The peak in the late 1990s to early 2000s suggests a saturation point, after which the decline reflects consolidation of plans or sponsor exits, a shift toward pooled or multi-employer arrangements, and market volatility post-2008 influencing plan formation.

This distribution is useful for stratifying plans by vintage. Plans initiated in different eras may have distinct design philosophies, contribution behaviors, or participant engagement patterns. A plan vintage feature (e.g. pre-1980, 1980–1999, post-2000) can help assess adequacy or access across cohorts. Pairing this variable with business code would allow sector-specific diagnostics, e.g. whether certain industries adopted plans earlier or more consistently.

# Plan Vintage Group (PLAN_VINTAGE_GROUP)

Engineer a plan vintage group variable.

```{r}
plans <- plans %>%
  mutate(PLAN_EFFECTIVE_YEAR = year(PLAN_EFFECTIVE_DATE),
    PLAN_VINTAGE_GROUP = case_when(
      PLAN_EFFECTIVE_YEAR < 1980 ~ "Legacy (Pre-1980)",
      PLAN_EFFECTIVE_YEAR >= 1980 & PLAN_EFFECTIVE_YEAR <= 1999 ~ "Expansion (1980–1999)",
      PLAN_EFFECTIVE_YEAR >= 2000 & PLAN_EFFECTIVE_YEAR <= 2009 ~ "Modern (2000–2009)",
      PLAN_EFFECTIVE_YEAR >= 2010 & PLAN_EFFECTIVE_YEAR <= 2019 ~ "Post-Crisis (2010–2019)",
      PLAN_EFFECTIVE_YEAR >= 2020 ~ "Recent (2020+)"),
    PLAN_VINTAGE_GROUP = factor(PLAN_VINTAGE_GROUP,levels = c("Legacy (Pre-1980)",
                                                              "Expansion (1980–1999)",
                                                              "Modern (2000–2009)",
                                                              "Post-Crisis (2010–2019)",
                                                              "Recent (2020+)"),
                                ordered = TRUE))
```

Plot plans by plan vintage group.

```{r}
summary_by_plan_vintage_group <- plans %>%
  group_by(PLAN_VINTAGE_GROUP) %>%
  summarise(entries = n()) %>%
  mutate(percent = round(entries / sum(entries), 2))

ggplot(summary_by_plan_vintage_group, aes(x = PLAN_VINTAGE_GROUP, y = entries)) +
  geom_col(fill = "steelblue", color = "white") +
  geom_text(aes(label = paste0(scales::comma(entries), "\n", round(percent * 100, 0), "%")),
            vjust = -0.3, size = 3.0) +
  labs(title = "Distribution of Plans By Plan Vintage Group",
       x = "Period",
       y = "Group") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5),
        plot.title = element_text(size = 14, face = "bold")) +
  expand_limits(y = max(summary_by_plan_vintage_group$entries) * 1.2)
```

Given this distribution, where plan counts rise sharply in the Expansion era and taper off in more recent vintages, we are dealing with a nonlinear, asymmetric pattern that’s not well captured by a simple linear term.

A spline would allow flexible modeling of nonlinear relationships without forcing global curvature.  I can place knots at meaningful breakpoints, e.g. 1980, 2000, 2010, using plan effective year to reflect policy or behavioral shifts. This would be easy to explain in stakeholder terms: plan creation changes around key regulatory eras.

When performing logistic regression, splines allow the model to capture non-linearity by breaking the predictor into segments and fitting piece-wise polynomials.

Random forests don’t need splines to model non-linearity. They’re built to handle it through recursive splits. However, engineering spline-based features can make comparisons cleaner and diagnostics more stakeholder-friendly.

# Plan Type (PLAN_TYPE)

In the landscape of employer-sponsored retirement plans, four distinct plan types often surface in nonprofit, education, and corporate sectors: 401(k), 403(b)(1), 403(b)(7), and 403(b)(9). Each reflects a unique structural and regulatory framework, shaping how participants accumulate retirement savings.

The 401(k) plan (code 2K) is the most prevalent defined contribution vehicle in the corporate world. It allows employees to defer a portion of their salary into tax-advantaged accounts, often with employer matching contributions. Its flexibility and widespread adoption make it a cornerstone of private-sector retirement readiness.

In contrast, the 403(b) family of plans caters to nonprofit and educational institutions. 

The 403(b)(1) annuity contract (code 2R) is structured around insurance-based annuities, offering a predictable, contract-driven approach to retirement accumulation.

The 403(b)(7) custodial account (code 2S) channels contributions into mutual funds held in custodial arrangements, providing participants with market-based growth potential and investment choice.

Distinct from these is the 403(b)(9) retirement income account (code 2T), designed specifically for churches and church-affiliated organizations. It blends the regulatory protections of 403(b) plans with the unique governance and income structures of religious institutions, often emphasizing long-term stability over investment variety.

Together, these plan types form the backbone of sector-aware retirement analytics. Understanding their structural nuances is essential for benchmarking adequacy, surfacing disparities, and designing fairness overlays that reflect the lived realities of participants across industries.

This field  is used to indicate the types of pension benefit features present in a plan. It’s a multi-valued field, meaning a single plan can report multiple codes concatenated into a single string.

Extract the relevant codes from the string and use them to create a new plan type name field.

```{r}
plans <- plans %>%
  mutate(PLAN_TYPE_NAME = case_when(str_detect(PLAN_TYPE, "2K") ~ "401(k)",
                                    str_detect(PLAN_TYPE, "2R") ~ "403(b)(1) Annuity",
                                    str_detect(PLAN_TYPE, "2S") ~ "403(b)(7) Custodial",
                                    str_detect(PLAN_TYPE, "2T") ~ "403(b)(9) Church"))
```

Generate summary by plan type name.

```{r}
summary_by_plan_type_name <- plans %>%
  group_by(PLAN_TYPE_NAME) %>%
  summarise(entries = n()) %>%
  arrange(desc(entries)) %>%
  mutate(percent = round(entries / sum(entries), 2))

kable(summary_by_plan_type_name,
      col.names = c("Plan Type", "Plans", "Percent"),
      caption = "Summary By Plan Type Name",
      format.args = list(big.mark = ","),
      align = c("l", "r", "r"))
```

Plot summary by plan type name.

```{r}
ggplot(summary_by_plan_type_name, aes(x = forcats::fct_reorder(PLAN_TYPE_NAME, 
                                                               entries, 
                                                              .desc = TRUE), y = entries)) +
  geom_col(fill = "steelblue", color = "white") +
  geom_text(aes(label = paste0(scales::comma(entries), "\n", round(percent * 100, 0), "%")),
            vjust = -0.3, size = 3.0) +
  labs(title = "Distribution of Plans By Plan Type Name",
       x = "Plan Type",
       y = "Plans") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5),
        plot.title = element_text(size = 14, face = "bold")) +
  expand_limits(y = max(summary_by_plan_type_name$entries) * 1.2)
```

This confirms the corporate sector’s pull in retirement plan design.

The remaining 12% is split across three structurally distinct 403(b) types.

# Sponsor State (SPONSOR_STATE)

This variable refers to the U.S. state listed in the mailing address of the plan sponsor on Form 5500. It captures the geographic location of the sponsor’s administrative contact, not necessarily the location of plan participants or operations.

This field is useful for regional benchmarking and comparing plan characteristics or adequacy across states, regulatory overlays, such as aligning with state-specific compliance or fiduciary rules, and geographic stratification.

Summarize plans by sponsor state.

```{r}
summary_by_sponsor_state <- plans %>%
  group_by(SPONSOR_STATE) %>%
  summarise(entries = n()) %>%
  arrange(desc(entries)) %>%
  mutate(percent = round(entries / sum(entries), 2))

kable(summary_by_sponsor_state,
      col.names = c("Sponsor State", "Plans", "Percent"),
      caption = "Summary By Sponsor State",
      format.args = list(big.mark = ","),
      align = c("l", "r", "r"))
```

Plot plans by state.

```{r}
ggplot(summary_by_sponsor_state, aes(x = forcats::fct_reorder(SPONSOR_STATE, 
                                                              entries, 
                                                              .desc = TRUE), y = entries)) +
  geom_col(fill = "steelblue", color = "white") +
  labs(title = "Distribution of Plans By Sponsor State",
       x = "State",
       y = "Plans") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 0),
        plot.title = element_text(size = 14, face = "bold")) +
  expand_limits(y = max(summary_by_sponsor_state$entries) * 1.2)
```

This distribution aligns closely with population density and economic concentration. States like California, Texas, New York, and Florida tend to dominate in plan counts because they host a large number of employers, especially in sectors with high plan adoption rates (e.g. finance, tech, healthcare).

High counts also reflect regional hubs of plan sponsors, especially in metro areas with strong retirement plan infrastructure.  States with proactive retirement initiatives, e.g. CalSavers in California, may show elevated plan formation or reporting.

I can potentially combine sponsor state with business code to see which industries drive plan formation in each region.

# Business Code and Industry Title (BUSINESS_CODE, INDUSTRY_TITLE)

Business code refers to the six-digit code used to classify the primary business activity of the plan sponsor, based on the North American Industry Classification System (NAICS). It identifies the economic sector in which the sponsoring organization operates—such as manufacturing, healthcare, finance, or education.  Industry title is the human-readable label associated with that code.

```{r}
summary_by_industry_title <- plans %>%
  group_by(INDUSTRY_TITLE) %>%
  summarise(entries = n()) %>%
  arrange(desc(entries)) %>%
  mutate(percent = round(entries / sum(entries), 2))

kable(head(summary_by_industry_title, 20),
      col.names = c("Industry", "Plans", "Percent"),
      caption = "Summary By Industry Title - Top 20 Industries",
      format.args = list(big.mark = ","),
      align = c("l", "r", "r"))
```

Representation at the detailed industry title level is sparse. Most individual NAICS-derived titles contribute less than 0.03% of total plan filings, which suggests that modeling or benchmarking at this granularity may be noisy or unstable.  A few industries dominate plan filings, while most contribute marginally. The detailed industry title field has many levels, but low support per level. Using these titles directly in models could lead to poor generalization unless grouped.

# Sector Code and Sector Title (SECTOR_CODE, SECTOR_TITLE)

Collapse to broader categories using existing business code structure and group industries into sectors.

```{r create_sectors}
business_codes <- readRDS("../data/business_codes.rds")

business_codes <- business_codes %>%
  rename(SECTOR_CODE = BUSINESS_CODE,
         SECTOR_TITLE = INDUSTRY_TITLE)

plans <- plans %>%
  mutate(SECTOR_CODE = as.integer(substr(BUSINESS_CODE, 1, 2)) * 10000)

plans <- left_join(plans, business_codes, by = "SECTOR_CODE")
```

Summarize plans by sector.

```{r}
summary_by_sector_title <- plans %>%
  group_by(SECTOR_TITLE) %>%
  summarise(entries = n()) %>%
  arrange(desc(entries)) %>%
  mutate(percent = round(entries / sum(entries), 2))

kable(summary_by_sector_title,
      col.names = c("Sector Title", "Plans", "Percent"),
      caption = "Summary By Sector Title",
      format.args = list(big.mark = ","),
      align = c("l", "r", "r"))
```

Plot by sector title.

```{r}
ggplot(summary_by_sector_title, aes(x = forcats::fct_reorder(stringr::str_trunc(SECTOR_TITLE, width = 20), 
                                                             entries, .desc = TRUE), y = entries)) +
  geom_col(fill = "steelblue", color = "white") +
  geom_text(aes(label = paste0(scales::comma(entries), "\n", round(percent * 100, 0), "%")),
            vjust = -0.3, size = 3.0) +
  labs(title = "Distribution of Plans By Sector",
       x = "Sector",
       y = "Plans") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5),
        plot.title = element_text(size = 14, face = "bold")) +
  expand_limits(y = max(summary_by_sector_title$entries) * 1.2)
```

This plot reveals an imbalance in plan availability across sectors. The top few, e.g Manufacturing, Professional Services, and Healthcare, dominate the landscape, accounting for over half of all plans. 

Saturated sectors like Manufacturing and Professional Services are likely have legacy plan structures and strong compliance cultures.

Healthcare shows high plan counts, possibly due to large institutional employers and unionized workforces.

Under-served sectors, such as Accommodation and Food Services, Arts and Entertainment, and Agriculture show very low plan counts despite employing millions. These sectors often have high turnover, part-time labor, or small businesses, all factors that historically correlate with low plan sponsorship.

In terms of predictors, I can leverage this insight by engineering two features: a plan penetration rate of plans per 1,000 employers or per 10,000 workers in each sector, and a sector adequacy flag that compares assets-per-participant or contribution ratios across sectors.  The first captures structural access to retirement plans across sectors.  I expect it will be a strong signal for access disparity and potential classification into “adequate” versus "inadequate” groups.

Binary or ordinal indicator based on sector-level averages of assets-per-participant or contribution ratios captures financial sufficiency of plans within each sector.  It may highlight whether certain industries consistently offer more robust retirement benefits.

Together, these features allow models to account for both who has access and how well those plans perform, making your adequacy classification more equitable and diagnostically transparent.

# Sector Participant Share (SECTOR_PARTICIPANT_SHARE)

Engineer a plan penetration rate variable.

```{r}
total_participants_all <- sum(plans$TOTAL_ACTIVE_PARTCP_EOY)

sector_participant_share <- plans %>%
  group_by(SECTOR_TITLE) %>%
  summarise(total_participants = sum(TOTAL_ACTIVE_PARTCP_EOY, na.rm = TRUE)) %>%
  mutate(percent_participants = round(total_participants / total_participants_all, 4)) %>%
  arrange(desc(percent_participants))

kable(sector_participant_share,
      col.names = c("Sector", "Participants", "Percent"),
      caption = "Participant Share By Sector",
      format.args = list(big.mark = ","),
      align = c("l", "r", "r"))
```

Plot participant share by sector.

```{r}
ggplot(sector_participant_share, aes(x = forcats::fct_reorder(stringr::str_trunc(SECTOR_TITLE, width = 20), 
                                                              total_participants, .desc = TRUE), 
                                     y = total_participants)) +
  geom_col(fill = "steelblue", color = "white") +
  # geom_text(aes(label = paste0(scales::comma(total_participants), "\n", round(percent_participants * 100, 0), "%")),
  #           vjust = -0.3, size = 3.0) +
  labs(title = "Distribution of Participants by Sector",
       x = "Sector",
       y = "Count") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5),
        plot.title = element_text(size = 14, face = "bold")) +
  expand_limits(y = max(sector_participant_share$total_participants) * 1.2)
```

This distribution reveals a disparity in coverage. High-coverage sectors like Manufacturing, Healthcare, and Retail dominate participant coverage. They most likely host large employers with institutional plans, unionized workforces, or strong compliance cultures. Their plans may be more standardized, with higher assets-per-participant and broader eligibility.

Low-coverage sectors like Agriculture, Mining, Education, and Public Administration (0.06%) are severely underrepresented. They may face structural barriers: seasonal labor, fragmented employment, or reliance on alternative retirement systems, e.g. public pensions are not captured in Form 5500.

# Sector Participant Share (SECTOR_PARTCP_SHARE)

Engineer participant share.

```{r}
sector_participant_share <- sector_participant_share %>%
  select(-total_participants) %>%
  rename(SECTOR_PARTCP_SHARE = percent_participants)

plans <- left_join(plans, sector_participant_share, by = "SECTOR_TITLE")
```

# Total Plan Assets (TOTAL_ASSETS_BOY, TOTAL_ASSETS_EOY)

These variables represent the total value of all plan assets held by the plan at the start and end of the plan year.

```{r}
summary_by_plan_assets <- plans %>%
  group_by(SECTOR_TITLE) %>%
  summarise(total_assets_boy = sum(TOTAL_ASSETS_BOY),
            total_assets_eoy = sum(TOTAL_ASSETS_EOY))

kable(summary_by_plan_assets,
      col.names = c("Sector", "BOY Assets", "EOY Assets"),
      caption = "BOY and EOY Total Plan Assets By Sector",
      format.args = list(big.mark = ","),
      align = c("l", "r", "r"))
```

Plot assets by sector.

```{r}
assets_long <- summary_by_plan_assets %>%
  pivot_longer(cols = c(total_assets_boy, total_assets_eoy),
               names_to = "Asset_Type",
               values_to = "Asset_Value")

ggplot(assets_long, aes(x = reorder(stringr::str_trunc(SECTOR_TITLE, width = 20), -Asset_Value), 
                        y = Asset_Value / 1e9, fill = Asset_Type)) +
  geom_bar(stat = "identity", position = "dodge") +
    scale_fill_manual(values = c("total_assets_boy" = "steelblue", "total_assets_eoy" = "lightsteelblue"),
                      labels = c("total_assets_boy" = "Beginning of Year", "total_assets_eoy" = "End of Year")) +
  labs(title = "BOY and EOY Total Plan Assets by Sector",
       x = "Sector",
       y = "Assets (Billions USD)",
       fill = "Asset Type") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5),
        plot.title = element_text(size = 14, face = "bold"))
```

Asset growth over the course of the year is consistent across all sectors.

# Total Assets Growth Rate (TOTAL_ASSETS_GROWTH_RATE)

Create a growth rate and assets per participant for each plan.

```{r}
plans <- plans %>%
  mutate(
    TOTAL_ASSETS_GROWTH_RATE = case_when(
      TOTAL_ASSETS_BOY == 0 & TOTAL_ASSETS_EOY > 0 ~ 1.0000,
      TOTAL_ASSETS_BOY == 0 & TOTAL_ASSETS_EOY == 0 ~ 0,
      TOTAL_ASSETS_BOY != 0 ~ round((TOTAL_ASSETS_EOY - TOTAL_ASSETS_BOY) / TOTAL_ASSETS_BOY, 4),
      TRUE ~ NA_real_))
```

Produce a density plot to show the distribution of asset growth rates.

One plan with an asset growth rate of 84% is a serious outlier and distorting the overall distribution.  I exclude the outlier in the following plot.

```{r}
ggplot(plans %>% filter(TOTAL_ASSETS_GROWTH_RATE <= 10), aes(x = TOTAL_ASSETS_GROWTH_RATE)) +
  geom_density(fill = "steelblue", alpha = 0.6) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray40") +
  labs(title = "Density of Total Assets Growth Rates (Excluding Outlier)",
       x = "Growth Rate",
       y = "Density") +
  theme_minimal()
```

Most plans have modest or stagnant asset growth, likely reflecting market conditions, contribution behavior, or plan maturity.

The right skew suggests a subset of plans with strong growth, possibly due to rollovers, mergers, or aggressive investment strategies.

The sharp peak near zero could indicate structural inertia, plans that are underfunded, inactive, or not receiving contributions.

Create a ridgeline plot by sector.

```{r}
plans %>%
  filter(TOTAL_ASSETS_GROWTH_RATE <= 10) %>%
  ggplot(aes(x = TOTAL_ASSETS_GROWTH_RATE, y = stringr::str_trunc(SECTOR_TITLE, width = 20))) +
  geom_density_ridges(bandwidth = 0.05, fill = "steelblue", alpha = 0.6) +
  labs(title = "Asset Growth Rate by Sector (≤ 10)",
       x = "Growth Rate",
       y = "Sector") +
  theme_minimal()
```

Most sectors cluster near zero; the sharp density around zero suggests widespread stagnation or minimal growth, possibly reflecting low contributions, market flatness, or plan maturity.

Right-skewed tails in sectors like Finance and Insurance, Real Estate, and Professional Services hint at pockets of aggressive growth, likely driven by rollovers, mergers, or high-income participant behavior.

Public sector plans (e.g. Educational Services, Health Care, Public Administration) show tighter distributions, possibly due to more regulated funding structures or consistent employer contributions.

Volatile sectors like Construction, Arts, and Accommodation show broader spread, likely reflecting economic sensitivity and participant turnover.

# Assets Per Participant (ASSETS_PER_PARTCP)

```{r}
plans <- plans %>%
  mutate(
    DENOMINATOR = case_when(
      TOTAL_ACCBAL_PARTCP_EOY > 0 ~ TOTAL_ACCBAL_PARTCP_EOY,
      TOTAL_ACTIVE_PARTCP_EOY > 0 ~ TOTAL_ACTIVE_PARTCP_EOY,
      TOTAL_ACTIVE_PARTCP_BOY > 0 ~ TOTAL_ACTIVE_PARTCP_BOY,
      TRUE ~ NA_real_),
    ASSETS_PER_PARTCP = round(TOTAL_ASSETS_EOY / DENOMINATOR, 0)) %>% 
  select(-DENOMINATOR)
```

Plot assets per participant

```{r}
ggplot(plans, aes(x = ASSETS_PER_PARTCP)) +
  geom_density(fill = "steelblue", alpha = 0.6) +
  geom_vline(xintercept = median(plans$ASSETS_PER_PARTCP, na.rm = TRUE), 
             linetype = "dashed", color = "darkred") +
  labs(title = "Density of Assets per Participant",
       x = "Assets per Participant (USD)",
       y = "Density") +
  theme_minimal()
```

That sharp peak near the lower end, followed by a long right tail, suggests most plans cluster below $100K per participant, but a few are pulling the average upward with much higher balances.

Plot the log-transformed distribution to reveal structure in the lower range.

```{r}
ggplot(plans, aes(x = log1p(ASSETS_PER_PARTCP))) +
  geom_density(fill = "steelblue", alpha = 0.6) +
  labs(title = "Log-Scaled Density of Assets per Participant",
       x = "log(Assets + 1)",
       y = "Density") +
  theme_minimal()
```

That peak around 10 corresponds to roughly $22,000–$25,000 per participant, which is a much more grounded estimate of typical adequacy than the inflated mean near $100K.

Most plans are far below the mean: The log transformation exposes that the bulk of plans cluster in the $10K–$30K range, not near six figures.

Long tail still exists: But now it’s visually compressed, allowing us to focus on the core distribution.

# Assets Per Participant Tier (ASSETS_PER_PARTCP_TIER)

Create assets per parrticipant tier labels.

```{r}
plans <- plans %>%
  mutate(
    ASSETS_PER_PARTCP_TIER = case_when(
      ASSETS_PER_PARTCP < 5000 ~ "< $5K",
      ASSETS_PER_PARTCP >= 5000 & ASSETS_PER_PARTCP < 25000 ~ "$5K–$25K",
      ASSETS_PER_PARTCP >= 25000 & ASSETS_PER_PARTCP < 50000 ~ "$25K–$50K",
      ASSETS_PER_PARTCP >= 50000 & ASSETS_PER_PARTCP < 100000 ~ "$50K–$100K",
      ASSETS_PER_PARTCP >= 100000 ~ "> $100K",
      TRUE ~ NA_character_),
    ASSETS_PER_PARTCP_TIER = factor(ASSETS_PER_PARTCP_TIER,
                           levels = c("< $5K", "$5K–$25K", "$25K–$50K", "$50K–$100K", "> $100K"),
                           ordered = TRUE))
```

Plot density by tier.

```{r}
ggplot(plans, aes(x = ASSETS_PER_PARTCP, fill = ASSETS_PER_PARTCP_TIER)) +
  geom_density(alpha = 0.6) +
  facet_wrap(~ ASSETS_PER_PARTCP_TIER, scales = "free") +
  scale_fill_manual(values = c("#B0C4DE", "#87AFC7", "#4682B4", "#36648B", "#27408B")) +
  labs(title = "Density of Assets Per Participant by Tier",
       x = "Assets per Participant (USD)",
       y = "Density") +
  theme_minimal() +
  theme(legend.position = "none")
```

The "< $5K" tier shows a tight peak near $1K, suggesting many plans cluster at very low adequacy. In contrast, the "$50K–$100K" tier is broader, indicating more heterogeneity in plan quality.

The "> $100K" tier is especially telling: a sharp peak just above $100K followed by a steep drop-off. That suggests a few high-performing plans dominate this tier, but most don’t go far beyond the threshold.

# Total Active Participants (TOTAL_ACTIVE_PARTCP_BOY, TOTAL_ACTIVE_PARTCP_EOY)

These variables provide the number of active participants in the plan as of the start and end of the reporting year. Active means eligible to contribute or currently contributing and includes employees who are actively participating or eligible to participate, even if they haven’t made contributions yet.  These variables reflect the current coverage footprint of the plan.

```{r}
summary_by_active_participants <- plans %>%
  group_by(SECTOR_TITLE) %>%
  summarise(total_active_boy = sum(TOTAL_ACTIVE_PARTCP_BOY),
            total_active_eoy = sum(TOTAL_ACTIVE_PARTCP_EOY))

kable(summary_by_active_participants,
      col.names = c("Sector", "BOY Participants", "EOY Participants"),
      caption = "BOY and EOY Total Active Participants By Sector",
      format.args = list(big.mark = ","),
      align = c("l", "r", "r"))
```

Plot active participants by sector.

```{r}
active_long <- summary_by_active_participants %>%
  pivot_longer(cols = c(total_active_boy, total_active_eoy),
               names_to = "Active_Type",
               values_to = "Active_Value")

ggplot(active_long, aes(x = reorder(stringr::str_trunc(SECTOR_TITLE, width = 20), -Active_Value), y = Active_Value / 1e9, fill = Active_Type)) +
  geom_bar(stat = "identity", position = "dodge") +
    scale_fill_manual(values = c("total_active_boy" = "steelblue", "total_active_eoy" = "lightsteelblue"),
                      labels = c("total_active_boy" = "Beginning of Year", "total_active_eoy" = "End of Year")) +
  labs(title = "BOY and EOY Total Active Participants by Sector",
       x = "Sector",
       y = "Active Participants",
       fill = "Active Type") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5),
        plot.title = element_text(size = 14, face = "bold"))
```

Manufacturing, Healthcare, and Professional Services again dominate in participant volume, mirroring their asset dominance. Sectors like Retail, Accommodation, and Arts show modest participant counts despite being labor-intensive, which may signal structural under-coverage.

The EOY bars generally exceed BOY, suggesting net growth in active participation, but the magnitude varies by sector.

# Participant Growth Rate (PARTCP_GROWTH_RATE)

Engineer participant growth rate at the plan level.

```{r}
plans <- plans %>%
  mutate(PARTCP_GROWTH_RATE = case_when(
    TOTAL_ACTIVE_PARTCP_BOY == 0 & TOTAL_ACTIVE_PARTCP_EOY > 0 ~ 1.0000,
    TOTAL_ACTIVE_PARTCP_BOY == 0 & TOTAL_ACTIVE_PARTCP_EOY == 0 ~ 0,
    TOTAL_ACTIVE_PARTCP_BOY != 0 ~ round((TOTAL_ACTIVE_PARTCP_EOY - TOTAL_ACTIVE_PARTCP_BOY) / TOTAL_ACTIVE_PARTCP_BOY, 4)))
```

Produce a density plot to show the distribution of participant growth rates.

One plan with a participant growth rate of 299% is a serious outlier and distorting the overall distribution.  I exclude the outlier in the following plot.

```{r}
ggplot(plans %>% filter(PARTCP_GROWTH_RATE <= 100), aes(x = PARTCP_GROWTH_RATE)) +
  geom_density(fill = "steelblue", alpha = 0.6) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray40") +
  labs(title = "Density of Participant Growth Rates",
       x = "Growth Rate",
       y = "Density") +
  theme_minimal()
```

Create a ridgeline plot by sector.

```{r}
plans %>%
  filter(PARTCP_GROWTH_RATE <= 100) %>%
  ggplot(aes(x = PARTCP_GROWTH_RATE, y = stringr::str_trunc(SECTOR_TITLE, width = 20))) +
  geom_density_ridges(bandwidth = 0.05, fill = "steelblue", alpha = 0.6) +
  labs(title = "Participant Growth Rate by Sector (≤ 100)",
       x = "Growth Rate",
       y = "Sector") +
  theme_minimal()
```

Most sectors seem tightly clustered near zero, and the horizontal scale compresses variation, making it hard to distinguish meaningful outliers or trends.

# Participant Growth Rate Tier (PARTCP_GROWTH_TIER)

Create a participant growth tier flag to delineate between negative, typical, and high growth plans.

```{r}
plans <- plans%>%
  mutate(PARTCP_GROWTH_TIER = case_when(PARTCP_GROWTH_RATE > 0.05 ~ "High Growth",
                                        PARTCP_GROWTH_RATE < -0.05 ~ "Negative Growth",
                                        TRUE ~ "Typical"),
             PARTCP_GROWTH_TIER = factor(PARTCP_GROWTH_TIER,
                                levels = c("Negative Growth", "Typical", "High Growth"),
                                ordered = TRUE))
```

Plot participant growth rates by sector with the growth tiers.

```{r}
ggplot(plans, aes(x = PARTCP_GROWTH_RATE, y = reorder(stringr::str_trunc(SECTOR_TITLE, width = 20), PARTCP_GROWTH_RATE), fill = PARTCP_GROWTH_TIER)) +
  geom_col() +
  scale_fill_manual(values = c("High Growth" = "steelblue", "Negative Growth" = "lightsteelblue", "Typical" = "gray70")) +
  labs(title = "Participant Growth Rate by Sector and Tier",
       x = "Growth Rate",
       y = "Sector",
       fill = "Growth Tier") +
  theme_minimal()
```

Participant growth rates vary meaningfully across sectors, and the flagged outliers, e.g. Manufacturing with high growth, Information with negative growth, suggest real economic or policy implications.

# Total Participant Contributions (TOTAL_CONTRIB_PARTCP_BOY, TOTAL_CONTRIB_PARTCP_EOY)

These variables capture the total dollar amount of participant contributions on record as of the start and end of the reporting year. The first reflects contributions made prior to the current plan year but still held in the plan. This is useful for understanding carryover balances or prior-year contribution momentum.

The latter includes all contributions made by participants during the year, plus any prior balances still retained.
It is often used to assess current-year contribution activity and participant engagement.

```{r}
summary_by_partcp_contributions <- plans %>%
  group_by(SECTOR_TITLE) %>%
  summarise(total_contrib_boy = sum(TOTAL_CONTRIB_PARTCP_BOY),
            total_contrib_eoy = sum(TOTAL_CONTRIB_PARTCP_EOY),
            .groups = "drop")

kable(summary_by_partcp_contributions,
      col.names = c("Sector", "BOY Contributions", "EOY Contributions"),
      caption = "BOY and EOY Total Contributions By Sector",
      format.args = list(big.mark = ","),
      align = c("l", "r", "r"))
```

Plot contributions by sector.

```{r}
contributions_long <- summary_by_partcp_contributions %>%
  pivot_longer(cols = c(total_contrib_boy, total_contrib_eoy),
               names_to = "Contribution_Type",
               values_to = "Contribution_Value")

ggplot(contributions_long, aes(x = reorder(stringr::str_trunc(SECTOR_TITLE, width = 20), -Contribution_Value), y = Contribution_Value / 1e9, fill = Contribution_Type)) +
  geom_bar(stat = "identity", position = "dodge") +
    scale_fill_manual(values = c("total_contrib_boy" = "steelblue", "total_contrib_eoy" = "lightsteelblue"),
                      labels = c("total_contrib_boy" = "Beginning of Year", "total_contrib_eoy" = "End of Year")) +
  labs(title = "BOY and EOY Total Contributions by Sector",
       x = "Sector",
       y = "Contributions",
       fill = "Contribution Type") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5),
        plot.title = element_text(size = 14, face = "bold"))
```

Manufacturing, Professional Services, and Hotels & Restaurants lead in total contributions, echoing their asset and participant dominance.

The EOY bars generally exceed BOY, suggesting net contribution inflows, but the magnitude and slope vary by sector.

Sectors like Information and Mining show relatively flat or modest contribution growth, which may flag under-engagement or structural constraints

# Participant Contribution Growth Rate (CONTRIB_PARTCP_GROWTH_RATE)

Engineer a contribution growth rate at the plan level.

```{r}
plans <- plans %>%
  mutate(CONTRIB_PARTCP_GROWTH_RATE = case_when(
    TOTAL_CONTRIB_PARTCP_BOY == 0 & TOTAL_CONTRIB_PARTCP_EOY > 0 ~ 1.0000,
    TOTAL_CONTRIB_PARTCP_BOY == 0 & TOTAL_CONTRIB_PARTCP_EOY == 0 ~ 0,
    TOTAL_CONTRIB_PARTCP_BOY == 0 & TOTAL_CONTRIB_PARTCP_EOY < 0 ~ 0,
    TOTAL_CONTRIB_PARTCP_BOY != 0 ~ round((TOTAL_CONTRIB_PARTCP_EOY - TOTAL_CONTRIB_PARTCP_BOY) / TOTAL_CONTRIB_PARTCP_BOY, 4)))
```

Produce a density plot to show the distribution of contribution growth rates.

One plan with a participant growth rate of 299% is a serious outlier and distorting the overall distribution.  I exclude the outlier in the following plot.

```{r}
ggplot(plans, aes(x = CONTRIB_PARTCP_GROWTH_RATE)) +
  geom_density(fill = "steelblue", alpha = 0.6) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray40") +
  labs(title = "Density of Contribution Growth Rates",
       x = "Growth Rate",
       y = "Density") +
  theme_minimal()
```

Create a ridgeline plot by sector.

```{r}
plans %>%
  filter(CONTRIB_PARTCP_GROWTH_RATE <= 100) %>%
  ggplot(aes(x = CONTRIB_PARTCP_GROWTH_RATE, y = stringr::str_trunc(SECTOR_TITLE, width = 20))) +
  geom_density_ridges(bandwidth = 0.05, fill = "steelblue", alpha = 0.6) +
  labs(title = "Contribution Growth Rate by Sector",
       x = "Growth Rate",
       y = "Sector") +
  theme_minimal()
```

Most sectors seem tightly clustered near zero, and the horizontal scale compresses variation, making it hard to distinguish meaningful outliers or trends.

# Participant Contribution Growth Tier (CONTRIB_PARTCP_GROWTH_TIER)

Create a contribution growth rate tier to delineate between negative, typical, and high growth plans.

```{r}
plans <- plans%>%
  mutate(CONTRIB_PARTCP_GROWTH_TIER= case_when(CONTRIB_PARTCP_GROWTH_RATE > 0.05 ~ "High Growth",
                                        CONTRIB_PARTCP_GROWTH_RATE < -0.05 ~ "Negative Growth",
                                        TRUE ~ "Typical"),
         CONTRIB_PARTCP_GROWTH_TIER = factor(CONTRIB_PARTCP_GROWTH_TIER,
                                levels = c("Negative Growth", "Typical", "High Growth"),
                                ordered = TRUE))
```

Plot contribution growth tiers by sector with the growth flags.

```{r}
ggplot(plans, aes(x = CONTRIB_PARTCP_GROWTH_RATE, y = reorder(stringr::str_trunc(SECTOR_TITLE, width = 20), CONTRIB_PARTCP_GROWTH_RATE), fill = CONTRIB_PARTCP_GROWTH_TIER)) +
  geom_col() +
  scale_fill_manual(values = c("High Growth" = "steelblue", "Negative Growth" = "lightsteelblue", "Typical" = "gray70")) +
  labs(title = "Contribution Growth Rate by Sector",
       x = "Growth Rate",
       y = "Sector",
       fill = "Growth Tier") +
  theme_minimal()
```

Transportation and warehousing, Mining, and Healthcare show strong contribution growth—suggesting active funding and participant engagement.

Information and Arts & Entertainment show negative growth, which could signal stagnation, plan attrition, or structural undercoverage.

# Average Contribution Per Participant (AVERAGE_CONTRIB_PER_PARTCP)

Implement average contribution per participant.

```{r}
plans <- plans %>%
  mutate(AVERAGE_CONTRIB_PER_PARTCP = case_when(
    TOTAL_CONTRIB_PARTCP_EOY < 0 ~ 0,
    TOTAL_ACCBAL_PARTCP_EOY == 0 & TOTAL_CONTRIB_PARTCP_EOY > 0 ~ 1.000,
    TOTAL_ACCBAL_PARTCP_EOY == 0 & TOTAL_CONTRIB_PARTCP_EOY == 0 ~ 0,
    TOTAL_ACCBAL_PARTCP_EOY != 0 ~ round(TOTAL_CONTRIB_PARTCP_EOY / TOTAL_ACCBAL_PARTCP_EOY, 4)))
```

Plot average contribution per participant by sector.

```{r}
summary_by_average_contribution <- plans %>%
  group_by(SECTOR_TITLE) %>%
  summarise(AVERAGE_CONTRIB_PER_PARTCP = mean(AVERAGE_CONTRIB_PER_PARTCP))

ggplot(summary_by_average_contribution, aes(x = AVERAGE_CONTRIB_PER_PARTCP, 
                                            y = reorder(stringr::str_trunc(SECTOR_TITLE, width = 20),
                                                              AVERAGE_CONTRIB_PER_PARTCP))) +
  geom_col(fill = "steelblue") +
  geom_text(aes(label = scales::comma(round(AVERAGE_CONTRIB_PER_PARTCP))),
            hjust = -0.1, size = 3.5) +
  scale_x_continuous(labels = scales::label_comma()) +

  labs(title = "Average Contribution per Participant by Sector",
       x = "Avg Contribution (USD)",
       y = "Sector") +
  theme_minimal() + 
  coord_cartesian(xlim = c(0, max(plans$AVERAGE_CONTRIB_PER_PARTCP) * 1.1))

```

# Contribution Per Participant Tier (CONTRIB_PER_PARTCP_TIER)

Create a tiered variable for average participant contribution.

```{r}
plans <- plans%>%
  mutate(CONTRIB_PER_PARTCP_TIER = cut(AVERAGE_CONTRIB_PER_PARTCP,
                       breaks = c(0, 1000, 2000, 3000, Inf),
                       labels = c("Low", "Moderate", "High", "Very High")),
         CONTRIB_PARTCP_GROWTH_TIER = factor(CONTRIB_PARTCP_GROWTH_TIER,
                                levels = c("Low", "Moderate", "High", "Very High"),
                                ordered = TRUE))
```

# Employer Contributions (TOTAL_CONTRIB_EMPLR_BOY, TOTAL_CONTRIB_EMPLR_EOY)

These variables represent the total dollar amount of employer contributions on record as of the start and end of the reporting year. They include contributions made during the year plus any retained prior balances and are often used to assess current-year employer funding and plan support.

```{r}
summary_er_contributions <- plans %>%
  group_by(SECTOR_TITLE) %>%
  summarise(total_contrib_boy = sum(TOTAL_CONTRIB_EMPLR_BOY),
            total_contrib_eoy = sum(TOTAL_CONTRIB_EMPLR_EOY),
            .groups = "drop")

kable(summary_er_contributions,
      col.names = c("Sector", "BOY Contributions", "EOY Contributions"),
      caption = "BOY and EOY Total Employer Contributions By Sector",
      format.args = list(big.mark = ","),
      align = c("l", "r", "r"))
```

Plot contributions by sector.

```{r}
er_contributions_long <- summary_er_contributions %>%
  pivot_longer(cols = c(total_contrib_boy, total_contrib_eoy),
               names_to = "Contribution_Type",
               values_to = "Contribution_Value")

ggplot(er_contributions_long, aes(x = reorder(stringr::str_trunc(SECTOR_TITLE, width = 20), -Contribution_Value), y = Contribution_Value / 1e9, fill = Contribution_Type)) +
  geom_bar(stat = "identity", position = "dodge") +
    scale_fill_manual(values = c("total_contrib_boy" = "steelblue", "total_contrib_eoy" = "lightsteelblue"),
                      labels = c("total_contrib_boy" = "Beginning of Year", "total_contrib_eoy" = "End of Year")) +
  labs(title = "BOY and EOY Total Employer Contributions by Sector",
       x = "Sector",
       y = "Contributions",
       fill = "Contribution Type") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5),
        plot.title = element_text(size = 14, face = "bold"))
```

Health care, Manufacturing, and Professional Services lead in employer contributions at both BOY and EOY, suggesting sustained institutional support.

The EOY bars generally exceed BOY, indicating net inflows, but the slope varies by sector. Some sectors show flat or modest growth, which may flag underfunding or stagnation.

Sectors like Arts & Entertainment, Accommodation, and Administrative Support show relatively low employer contributions, which could signal structural gaps in plan generosity.

# Employer Contribution Growth Rate (CONTRIB_EMPLR_GROWTH_RATE)

Engineer a contribution growth rate at the plan level.

```{r}
plans <- plans %>%
  mutate(CONTRIB_EMPLR_GROWTH_RATE = case_when(
    TOTAL_CONTRIB_EMPLR_BOY == 0 & TOTAL_CONTRIB_EMPLR_EOY > 0 ~ 1.0000,
    TOTAL_CONTRIB_EMPLR_BOY == 0 & TOTAL_CONTRIB_EMPLR_EOY == 0 ~ 0,
    TOTAL_CONTRIB_EMPLR_BOY == 0 & TOTAL_CONTRIB_EMPLR_EOY < 0 ~ 0,
    TOTAL_CONTRIB_EMPLR_BOY != 0 ~ round((TOTAL_CONTRIB_EMPLR_EOY - TOTAL_CONTRIB_EMPLR_BOY) / TOTAL_CONTRIB_EMPLR_BOY, 4)))
```

Produce a density plot to show the distribution of contribution growth rates.

```{r}
ggplot(plans, aes(x = CONTRIB_EMPLR_GROWTH_RATE)) +
  geom_density(fill = "steelblue", alpha = 0.6) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray40") +
  labs(title = "Density of Employer Contribution Growth Rates",
       x = "Growth Rate",
       y = "Density") +
  theme_minimal()
```

Create a ridgeline plot by sector.

```{r}
plans %>%
  ggplot(aes(x = CONTRIB_EMPLR_GROWTH_RATE, y = stringr::str_trunc(SECTOR_TITLE, width = 20))) +
  geom_density_ridges(bandwidth = 0.05, fill = "steelblue", alpha = 0.6) +
  labs(title = "Employer Contribution Growth Rate by Sector",
       x = "Growth Rate",
       y = "Sector") +
  theme_minimal()
```

Most sectors seem tightly clustered near zero, and the horizontal scale compresses variation, making it hard to distinguish meaningful outliers or trends.

# Employer Contribution Growth Tier (CONTRIB_EMPLR_GROWTH_TIER)

Create an employer contribution growth rate flag to delineate between negative, typical, and high growth plans.

```{r}
plans <- plans%>%
  mutate(CONTRIB_EMPLR_GROWTH_TIER = case_when(CONTRIB_EMPLR_GROWTH_RATE > 0.05 ~ "High Growth",
                                               CONTRIB_EMPLR_GROWTH_RATE < -0.05 ~ "Negative Growth",
                                               TRUE ~ "Typical"),
         CONTRIB_EMPLR_GROWTH_TIER = factor(CONTRIB_EMPLR_GROWTH_TIER,
                                levels = c("Negative Growth", "Typical", "High Growth"),
                                ordered = TRUE))
```

Plot contribution growth rates by sector with the growth flags.

```{r}
ggplot(plans, aes(x = CONTRIB_EMPLR_GROWTH_RATE, y = reorder(stringr::str_trunc(SECTOR_TITLE, width = 20), CONTRIB_EMPLR_GROWTH_RATE), fill = CONTRIB_EMPLR_GROWTH_TIER)) +
  geom_col() +
  scale_fill_manual(values = c("High Growth" = "steelblue", "Negative Growth" = "lightsteelblue", "Typical" = "gray70")) +
  labs(title = "Employer Contribution Growth Rate by Sector",
       x = "Growth Rate",
       y = "Sector",
       fill = "Growth Category") +
  theme_minimal()
```

Transportation and warehousing stands out with exceptional growth—this could reflect increased employer investment, plan expansion, or policy shifts.

Educational services and Wholesale trade also show strong growth, which may signal rising institutional support in traditionally underfunded sectors.

Several sectors show negative growth (e.g., Information, Arts & Entertainment), which could indicate declining employer engagement, plan attrition, or funding retraction.

# Participant Loans (TOTAL_LOANS_BOY, TOTAL_LOANS_EOY)

These fields reflect the aggregate amount participants have borrowed from their retirement accounts and not yet repaid. Loans are typically allowed under 401(k) and some 403(b) plans, subject to IRS limits (usually up to $50,000 or 50% of vested account balance).

Comparing BOY vs. EOY values helps surface net borrowing or repayment trends. A rising EOY balance may signal increased participant financial stress or plan leniency.

High loan balances can erode retirement adequacy. Plans with high loan-to-asset ratios or frequent borrowing as needing closer scrutiny.

```{r}
summary_loans <- plans %>%
  group_by(SECTOR_TITLE) %>%
  summarise(total_loans_boy = sum(TOTAL_LOANS_BOY),
            total_loans_eoy = sum(TOTAL_LOANS_EOY),
            .groups = "drop")

kable(summary_loans,
      col.names = c("Sector", "BOY Loans", "EOY Loans"),
      caption = "BOY and EOY Total Loan Balances By Sector",
      format.args = list(big.mark = ","),
      align = c("l", "r", "r"))
```

Plot loans by sector.

```{r}
er_loans_long <- summary_loans %>%
  pivot_longer(cols = c(total_loans_boy, total_loans_eoy),
               names_to = "Loan_Type",
               values_to = "Loan_Value")

ggplot(er_loans_long, aes(x = reorder(stringr::str_trunc(SECTOR_TITLE, width = 20), -Loan_Value), y = Loan_Value, fill = Loan_Type)) +
  geom_bar(stat = "identity", position = "dodge") +
    scale_fill_manual(values = c("total_loans_boy" = "steelblue", "total_loans_eoy" = "lightsteelblue"),
                      labels = c("total_loans_boy" = "Beginning of Year", "total_loans_eoy" = "End of Year")) +
  labs(title = "BOY and EOY Total Loan Balances by Sector",
       x = "Sector",
       y = "Loans",
       fill = "Loan Type") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5),
        plot.title = element_text(size = 14, face = "bold"))
```

Loan balances are rising in most sectors.

The light blue EOY bars often exceed the dark blue BOY bars, suggesting net borrowing across the year. That’s a potential red flag for participant liquidity strain or plan leniency.

Manufacturing and Health Care lead in total loan volume.  These sectors show the highest absolute balances—likely due to large participant bases and higher plan penetration. But it also raises questions about adequacy erosion and fallback logic.

Professional and Technical Services show modest growth.  Possibly reflecting more conservative borrowing behavior or stronger financial wellness programs.

Church and public sectors (e.g., Educational Services, Public Administration) show lower balances.  This aligns with structural plan constraints—403(b)(9) and some 403(b)(1) plans often restrict loans or discourage borrowing.

# Has Outstanding Loans (HAS_OUTSTANDING_LOANS)

Engineer a binary variable that identifies whether a plan has outstanding loan balances or not.

```{r}
plans <- plans %>%
  mutate(HAS_OUTSTANDING_LOANS = case_when(TOTAL_LOANS_BOY > 0 | TOTAL_LOANS_EOY > 0 ~ 1,
                                           TRUE ~ 0))
```

```{r}
summary_os_loans <- plans %>%
  group_by(SECTOR_TITLE, HAS_OUTSTANDING_LOANS) %>%
  summarise(entries = n()) %>%
  pivot_wider(names_from = HAS_OUTSTANDING_LOANS,
              values_from = entries)

kable(summary_os_loans,
      col.names = c("Sector", "No Loans", "Loans"),
      caption = "BOY and EOY Total Loans Outstanding By Sector",
      format.args = list(big.mark = ","),
      align = c("l", "r", "r"))
```

# Loan Leakage Ratio (LOAN_LEAKAGE_RATIO)

```{r}
plans <- plans %>%
  mutate(LOAN_LEAKAGE_RATIO = if_else(TOTAL_LOANS_EOY == 0 & TOTAL_ASSETS_EOY == 0, 
                                      0, 
                                      round(TOTAL_LOANS_EOY / TOTAL_ASSETS_EOY, 4)))
```

# Loan Leakage Tier (LOAN_LEAKAGE_TIER)

```{r}
plans <- plans %>%
  mutate(LOAN_LEAKAGE_TIER = case_when(LOAN_LEAKAGE_RATIO == 0 ~ "None",
                                       TRUE ~ as.character(cut(LOAN_LEAKAGE_RATIO,
                                                               breaks = c(0, 0.05, 0.1, 0.15, 0.2, Inf),
                                                               labels = c("Minimal", "Low", "Moderate", "High", "Very High"),
                                                               right = FALSE))),
         LOAN_LEAKAGE_TIER = factor(LOAN_LEAKAGE_TIER,
                                    levels = c("None", "Minimal", "Low", "Moderate", "High", "Very High"),
                                    ordered = TRUE))
```

# Retirement Adequacy Score (ADEQUACY_SCORE, ADEQUACY_IND, ADEQUACY_LABEL) 

This response variable is designed to classify retirement plans as adequate or inadequate based on a principled, multi-signal framework. Rather than relying on a single metric, it integrates four structural indicators of plan health:

Assets per Participant > $50,000 signals long-term saving capacity and participant wealth accumulation.

Asset Growth Rate > 5% reflects sustained engagement and financial momentum over time.

Average Contributions per Participant > $2,000 indicates meaningful participant deferral behavior and plan utilization.

Loan Leakage Ratio < 0.5 captures erosion risk due to participant borrowing; lower ratios suggest stronger adequacy.

Each condition is evaluated as a binary flag, and the adequacy score is the sum of conditions met. Plans meeting three or more criteria are classified as adequate.

```{r}
plans <- plans %>%
  mutate(ADEQUACY_SCORE = (ASSETS_PER_PARTCP > 50000) +
                          (TOTAL_ASSETS_GROWTH_RATE > 0.05) +
                          (AVERAGE_CONTRIB_PER_PARTCP > 2000) +
                          (LOAN_LEAKAGE_RATIO < 0.5),
         ADEQUACY_IND = if_else(ADEQUACY_SCORE >= 3, 1L, 0L),
         ADEQUACY_LABEL = if_else(ADEQUACY_IND == 1L, "Adequate", "Inadequate"))
```

This approach offers several advantages:

Interpretability; Stakeholders can trace adequacy classification to specific, transparent thresholds.

Diagnostic clarity: Each component reflects a distinct dimension of plan health—accumulation, growth, engagement, and leakage.

Fairness-aware: By requiring multiple criteria, the model avoids overfitting to any one sector or plan type.

Model-ready: The binary label supports classification tasks, while the tiered label enables stakeholder previews and fairness overlays.

This response variable scaffolds ethical modeling, stakeholder trust, and reproducible diagnostics, all central to my analytic philosophy for this project.

# Finalize and Save Dataset

Order variables and save plans data frame with updates and features.

```{r}
plans <- plans %>%
  select(ADEQUACY_LABEL,
         ADEQUACY_IND,
         ADEQUACY_SCORE,
         ACK_ID,
         PLAN_YEAR_BEGIN_DATE,
         PLAN_YEAR_END_DATE,
         PLAN_NAME,
         PLAN_EFFECTIVE_DATE,
         PLAN_EFFECTIVE_YEAR,
         PLAN_VINTAGE_GROUP,
         PLAN_TYPE,
         PLAN_TYPE_NAME,
         SPONSOR_NAME,
         SPONSOR_STATE,
         SPONSOR_EIN,
         BUSINESS_CODE,
         INDUSTRY_TITLE,
         SECTOR_CODE,
         SECTOR_TITLE,
         SECTOR_PARTCP_SHARE,
         TOTAL_ACTIVE_PARTCP_BOY,
         TOTAL_ACTIVE_PARTCP_EOY,
         TOTAL_ACCBAL_PARTCP_BOY,
         TOTAL_ACCBAL_PARTCP_EOY,
         PARTCP_GROWTH_RATE,
         PARTCP_GROWTH_TIER,
         TOTAL_CONTRIB_PARTCP_BOY,
         TOTAL_CONTRIB_PARTCP_EOY,
         CONTRIB_PARTCP_GROWTH_RATE,
         CONTRIB_PARTCP_GROWTH_TIER,
         AVERAGE_CONTRIB_PER_PARTCP,
         CONTRIB_PER_PARTCP_TIER,
         TOTAL_CONTRIB_EMPLR_BOY,
         TOTAL_CONTRIB_EMPLR_EOY,
         CONTRIB_EMPLR_GROWTH_RATE,
         CONTRIB_EMPLR_GROWTH_TIER,
         TOTAL_LOANS_BOY,
         TOTAL_LOANS_EOY, 
         HAS_OUTSTANDING_LOANS,
         LOAN_LEAKAGE_RATIO,
         LOAN_LEAKAGE_TIER,
         TOTAL_ASSETS_BOY,
         TOTAL_ASSETS_EOY,
         TOTAL_ASSETS_GROWTH_RATE,
         ASSETS_PER_PARTCP,
         ASSETS_PER_PARTCP_TIER)

saveRDS(plans, "../data/plans_final.rds")
```

