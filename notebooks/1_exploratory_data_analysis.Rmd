---
title: "Classifying Retirement Plan Financial Adequacy Using Form 5500 Data"
subtitle: "Exploratory Data Analysis"
author: "Donnie Minnick, Statistical Learning - Fall A 2025"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
---

The analysis leverages the following R packages: `caret` for model training and evaluation, `dplyr` for data manipulation, `knitr` for report formatting, and `pROC` for ROC/AUC analysis.

```{r, load_libraries echo = FALSE, message = FALSE}
library("caret")
library("dplyr")
library("ggplot2")
library("knitr")
library("lubridate")
library("pROC")
library("tidyr")
```

```{r load_data}
plans <- readRDS("../data/plans.rds")
```

# Missing Data

```{r missing_data}
# Create column level summary.

col_missing <- plans %>%
  summarise(across(everything(), ~ sum(is.na(.)))) %>%
  pivot_longer(cols = everything(),
               names_to = "Variable",
               values_to = "Missing_Count") %>%
  mutate(Missing_Percent = Missing_Count / nrow(plans) * 100)

# Create row level summary.

row_missing <- tibble(Variable = "Rows Any Missing",
                      Missing_Count = sum(!complete.cases(plans)),
                      Missing_Percent = sum(!complete.cases(plans)) / nrow(plans) * 100)

# Combine summaries.

missing_report <- bind_rows(col_missing, row_missing)

kable(missing_report,
      col.names = c("Variable", "Missing Count", "Missing Percent"),
      caption = "Missing Data",
      format.args = list(big.mark = ","),
      align = c("l", "r", "r"))
```

# Plan Effective Date (PLAN_EFF_DATE)

The variable PLAN_EFF_DATE marks the official inception of a retirement plan, i.e. the date it became active and enforceable under its governing provisions. This date anchors the plan’s life-cycle, serving as a reference point for regulatory applicability, sponsor tenure, and cohort benchmarking.

From an analytic perspective, PLAN_EFF_DATE enables several valuable transformations.  Calculating plan age from this field allows for stratification by maturity, which  is especially useful when assessing financial readiness across vintage cohorts.  Plans initiated in different eras may reflect distinct design philosophies, contribution behaviors, or participant engagement patterns. 

Grouping by effective date also supports fairness overlays, helping identify whether newer plans offer comparable adequacy and access relative to legacy plans.

In benchmarking workflows, PLAN_EFF_DATE can be paired with BUSINESS_CODE to explore sector-specific adoption trends. As a foundational variable, it’s ideal for anchoring longitudinal diagnostics and enriching sponsor life-cycle narratives.

```{r}
summary_plan_effective_date <- plans %>%
  mutate(PLAN_EFF_YEAR = year(PLAN_EFF_DATE)) %>%
  group_by(PLAN_EFF_YEAR) %>%
  arrange(PLAN_EFF_YEAR) %>%
  summarise(entries = n(), .groups = "drop") %>%
  mutate(percent = round(entries / sum(entries), 2))

kable(summary_plan_effective_date,
      col.names = c("Plan Effective Year", "Entries", "Percent"),
      caption = "Summary Plan Effective Year",
      format.args = list(big.mark = ","),
      align = c("l", "r", "r"))
```

Plot plans by plan effective year.

```{r}
ggplot(summary_plan_effective_date, aes(x = PLAN_EFF_YEAR, y = entries)) +
  geom_col(fill = "steelblue", color = "white") +
  # geom_text(aes(label = paste0(scales::comma(entries), "\n", round(percent * 100, 0), "%")),
  #           vjust = -0.3, size = 3.0) +
  labs(title = "Distribution of Plan Effective Dates By Year",
       x = "Year",
       y = "Count") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        plot.title = element_text(size = 14, face = "bold")) +
  expand_limits(y = max(summary_plan_effective_date$entries) * 1.2)
```

This distribution tells a compelling story about the evolution of retirement plan adoption in the U.S. The gradual rise from the 1940s through the 1970s reflects the early institutionalization of employer-sponsored plans, likely driven by post-war economic expansion and the formalization of pension structures.

The sharp uptick in the late 1970s through the 1990s coincides with major policy shifts, most notably the passage of ERISA in 1974 and the rise of defined contribution plans like 401(k)s in the early 1980s. This era marks a surge in plan formation,  especially among small and mid-sized employers responding to new regulatory clarity and tax incentives.

The peak in the late 1990s to early 2000s suggests a saturation point, after which the decline may reflect consolidation of plans or sponsor exits, a shift toward pooled or multi-employer arrangements, and market volatility post-2008 influencing plan  formation.

From a benchmarking or fairness audit perspective, this distribution is useful for stratifying plans by vintage. Plans initiated in different eras may have distinct design philosophies, contribution behaviors, or participant engagement patterns. A plan vintage feature (e.g., pre-1980, 1980–1999, post-2000) can help assess adequacy or access across cohorts. Pairing this variable with BUSINESS_CODE would allow sector-specific diagnostics, e.g., whether certain industries adopted plans earlier or more consistently.

```{r plan_vintage_group}
plans <- plans %>%
  mutate(
    PLAN_EFF_YEAR = year(PLAN_EFF_DATE),
    PLAN_VINTAGE_GROUP = case_when(
      PLAN_EFF_YEAR < 1980 ~ "Legacy (Pre-1980)",
      PLAN_EFF_YEAR >= 1980 & PLAN_EFF_YEAR <= 1999 ~ "Expansion (1980–1999)",
      PLAN_EFF_YEAR >= 2000 & PLAN_EFF_YEAR <= 2009 ~ "Modern (2000–2009)",
      PLAN_EFF_YEAR >= 2010 & PLAN_EFF_YEAR <= 2019 ~ "Post-Crisis (2010–2019)",
      PLAN_EFF_YEAR >= 2020 ~ "Recent (2020+)"),
    PLAN_VINTAGE_GROUP = factor(PLAN_VINTAGE_GROUP,levels = c("Legacy (Pre-1980)",
                                                              "Expansion (1980–1999)",
                                                              "Modern (2000–2009)",
                                                              "Post-Crisis (2010–2019)",
                                                              "Recent (2020+)"),
                                ordered = TRUE))
```

Plot plans by plan vintage group.

```{r}
summary_plan_vintage_group <- plans %>%
  group_by(PLAN_VINTAGE_GROUP) %>%
  summarise(entries = n(), .groups = "drop") %>%
  mutate(percent = round(entries / sum(entries), 2))

ggplot(summary_plan_vintage_group, aes(x = PLAN_VINTAGE_GROUP, y = entries)) +
  geom_col(fill = "steelblue", color = "white") +
  geom_text(aes(label = paste0(scales::comma(entries), "\n", round(percent * 100, 0), "%")),
            vjust = -0.3, size = 3.0) +
  labs(title = "Distribution of Plans By Plan Vintage Group",
       x = "Year",
       y = "Count") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        plot.title = element_text(size = 14, face = "bold")) +
  expand_limits(y = max(summary_plan_vintage_group$entries) * 1.2)
```

Given this distribution, where plan counts rise sharply in the Expansion era and taper off in more recent vintages, we are dealing with a nonlinear, asymmetric pattern that’s not well captured by a simple linear term.

A spline would allow flexible modeling of nonlinear relationships without forcing global curvature.  I can place knots at meaningful breakpoints, e.g., 1980, 2000, 2010, using PLAN_EFF_YEAR to reflect policy or behavioral shifts. This would be easy to explain in stakeholder terms: plan creation changes around key regulatory eras.

When performing logistic regression, splines allow the model to capture non-linearity by breaking the predictor into segments and fitting piecewise polynomials.

Random forests don’t need splines to model non-linearity. They’re built to handle it through recursive splits. However, engineering spline-based features can make comparisons cleaner and diagnostics more stakeholder-friendly.

# State (SPONS_DFE_MAIL_US_STATE)

The variable SPONS_DFE_MAIL_US_STATE refers to the U.S. state listed in the mailing address of the plan sponsor or Direct Filing Entity (DFE) on Form 5500. It captures the geographic location of the sponsor’s administrative contact, not necessarily the location of plan participants or operations.

This field is useful for regional benchmarking and comparing plan characteristics or adequacy across states, regulatory overlays, such as aligning with state-specific compliance or fiduciary rules, and geographic stratification.

```{r}
summary_sponsor_state <- plans %>%
  group_by(SPONS_DFE_MAIL_US_STATE) %>%
  summarise(entries = n(), .groups = "drop") %>%
  arrange(desc(entries)) %>%
  mutate(percent = round(entries / sum(entries), 2))

kable(summary_sponsor_state,
      col.names = c("Sponsor State", "Entries", "Percent"),
      caption = "Summary Sponsor State",
      format.args = list(big.mark = ","),
      align = c("l", "r", "r"))
```

Plot plans by state.

```{r}
ggplot(summary_sponsor_state, aes(x = forcats::fct_reorder(SPONS_DFE_MAIL_US_STATE, entries, .desc = TRUE), y = entries)) +
  geom_col(fill = "steelblue", color = "white") +
  # geom_text(aes(label = paste0(scales::comma(entries), "\n", round(percent * 100, 0), "%")),
  #           vjust = -0.3, size = 3.0) +
  labs(title = "Distribution of Plans By Sponsor State",
       x = "Year",
       y = "Count") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5),
        plot.title = element_text(size = 14, face = "bold")) +
  expand_limits(y = max(summary_sponsor_state$entries) * 1.2)
```

This distribution aligns closely with population density and economic concentration. States like California, Texas, New York, and Florida tend to dominate in plan counts because they host a large number of employers, especially in sectors with high plan adoption rates (e.g., finance, tech, healthcare).

It's also about business density and industry mix. High counts may reflect regional hubs of plan sponsors, especially in metro areas with strong retirement plan infrastructure.  Also, states with proactive retirement initiatives, e.g., CalSavers in California, may show elevated plan formation or reporting.

I can potentially combine BUSINESS_CODE with state to see which industries drive plan formation in each region.

# Business Code and Industry Title (BUSINESS_CODE, INDUSTRY_TITLE)

The BUSINESS_CODE field on Form 5500 refers to the six-digit code used to classify the primary business activity of the plan sponsor, based on the North American Industry Classification System (NAICS). It identifies the economic sector in which the sponsoring organization operates—such as manufacturing, healthcare, finance, or education.  The INDUSTRY_TITLE is the human-readable label associated with that code.

```{r}
summary_industry_title <- plans %>%
  group_by(INDUSTRY_TITLE) %>%
  summarise(entries = n(), .groups = "drop") %>%
  arrange(desc(entries)) %>%
  mutate(percent = round(entries / sum(entries), 2))

kable(head(summary_industry_title, 20),
      col.names = c("Industry", "Entries", "Percent"),
      caption = "Summary Industry - Top 20 Entries",
      format.args = list(big.mark = ","),
      align = c("l", "r", "r"))
```

The representation at the detailed industry title level is sparse. Most individual NAICS-derived titles contribute less than 0.03% of total plan filings, which suggests that modeling or benchmarking at this granularity may be noisy or unstable.  A few industries dominate plan filings, while most contribute marginally. The detailed industry title field has many levels, but low support per level. Using these titles directly in models could lead to poor generalization unless grouped.

I will collapse to broader categories using existing business code structure to group industries into super-sectors. This reduces cardinality and improves interpretability.

```{r}
readRDS("../data/business_codes.rds")

business_codes <- business_codes %>%
  rename(SECTOR_CODE = BUSINESS_CODE,
         SECTOR_TITLE = INDUSTRY_TITLE)

plans <- plans %>%
  mutate(SECTOR_CODE = as.integer(substr(BUSINESS_CODE, 1, 2)) * 10000)

plans <- left_join(plans, business_codes, by = "SECTOR_CODE")

summary_sector_title <- plans %>%
  group_by(SECTOR_TITLE) %>%
  summarise(entries = n(), .groups = "drop") %>%
  arrange(desc(entries)) %>%
  mutate(percent = round(entries / sum(entries), 2))

kable(summary_sector_title,
      col.names = c("Sector", "Entries", "Percent"),
      caption = "Summary Sector",
      format.args = list(big.mark = ","),
      align = c("l", "r", "r"))
```

Plot by sector title.

```{r}
ggplot(summary_sector_title, aes(x = forcats::fct_reorder(stringr::str_trunc(SECTOR_TITLE, width = 20), entries, .desc = TRUE), y = entries)) +
  geom_col(fill = "steelblue", color = "white") +
  geom_text(aes(label = paste0(scales::comma(entries), "\n", round(percent * 100, 0), "%")),
            vjust = -0.3, size = 3.0) +
  labs(title = "Distribution of Plans By Sector",
       x = "Sector",
       y = "Count") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5),
        plot.title = element_text(size = 14, face = "bold")) +
  expand_limits(y = max(summary_sector_title$entries) * 1.2)


```

This plot reveals an imbalance in plan availability across sectors. The top few, e.g Manufacturing, Professional Services, and Healthcare, dominate the landscape, accounting for over half of all plans. 

Saturated sectors like Manufacturing and Professional Services are likely have legacy plan structures and strong compliance cultures.

Healthcare shows high plan counts, possibly due to large institutional employers and unionized workforces.

Under-served sectors, such as Accommodation and Food Services, Arts and Entertainment, and Agriculture show very low plan counts despite employing millions. These sectors often have high turnover, part-time labor, or small businesses, all factors that historically correlate with low plan sponsorship.

In terms of predictors, I can leverage this insight by engineering two features: a plan penetration rate of plans per 1,000 employers or per 10,000 workers in each sector, and a sector adequacy flag that compares assets-per-participant or contribution ratios across sectors.  The first captures structural access to retirement plans across sectors.  I expect it will be a strong signal for access disparity and potential classification into “adequate” versus "inadequate” groups.

Binary or ordinal indicator based on sector-level averages of assets-per-participant or contribution ratios captures financial sufficiency of plans within each sector.  It may highlight whether certain industries consistently offer more robust retirement benefits.

Together, these features allow models to account for both who has access and how well those plans perform, making your adequacy classification more equitable and diagnostically transparent.

Implement plan penetration rate.

```{r}
# Count plans per sector

plan_count <- plans %>%
  group_by(SECTOR_CODE) %>%
  summarise(plan_count = n())

employer_counts <- plans %>%
  select(SECTOR_CODE, SPONS_DFE_EIN) %>%
  distinct_all() %>%
  group_by(SECTOR_CODE) %>%
  summarise(employer_count = n())

penetration <- left_join(plan_counts, employer_counts, by = "SECTOR_CODE") %>%
  mutate(plans_per_1000_employers = (plan_counts / employer_counts) * 1000,
         plans_per_10000_workers = (plan_counts / employer_counts) * 10000)

check <- plans %>%
  group_by(SPONS_DFE_EIN) %>%
  summarise(count = n())
```






